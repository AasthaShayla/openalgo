{% extends 'base.html' %}

{% block head %}
<style>
    .table-container {
        @apply overflow-x-auto bg-base-100 rounded-lg shadow-lg mt-8;
    }

    .table-header {
        @apply sticky top-0 bg-base-200 z-10;
    }

    .trade-buy {
        @apply text-success font-semibold;
    }

    .trade-sell {
        @apply text-error font-semibold;
    }

    .trade-value {
        @apply font-mono;
    }

    .trade-time {
        @apply text-sm text-base-content/70;
    }

    .trade-action {
        @apply badge font-semibold;
    }

    .trade-action-buy {
        @apply badge-success;
    }

    .trade-action-sell {
        @apply badge-error;
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full">
    <!-- Header Section -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold">Trade Book</h1>
        <p class="text-base-content/60">View your trading history and executed orders</p>
    </div>

    <!-- Trade Summary -->
    <div class="stats shadow w-full">
        <div class="stat">
            <div class="stat-title">Total Trades</div>
            <div class="stat-value">{{ tradebook_data|length }}</div>
            <div class="stat-desc">All executed trades</div>
        </div>
        
        <div class="stat">
            <div class="stat-title">Buy Trades</div>
            <div class="stat-value text-success">
                {{ tradebook_data|selectattr('action', 'equalto', 'BUY')|list|length }}
            </div>
            <div class="stat-desc text-success">Long positions</div>
        </div>
        
        <div class="stat">
            <div class="stat-title">Sell Trades</div>
            <div class="stat-value text-error">
                {{ tradebook_data|selectattr('action', 'equalto', 'SELL')|list|length }}
            </div>
            <div class="stat-desc text-error">Short positions</div>
        </div>
    </div>

    <!-- Trades Table -->
    <div class="table-container">
        <table class="table w-full">
            <thead class="table-header">
                <tr>
                    <th class="cursor-pointer hover:bg-base-300">
                        Trading Symbol
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        </svg>
                    </th>
                    <th>Exchange</th>
                    <th>Product Type</th>
                    <th>Transaction Type</th>
                    <th>Fill Size</th>
                    <th>Fill Price</th>
                    <th>Trade Value</th>
                    <th>Order ID</th>
                    <th>Fill Time</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in tradebook_data %}
                <tr class="hover:bg-base-200">
                    <td class="font-medium">{{ trade.symbol }}</td>
                    <td>
                        <div class="badge badge-ghost">{{ trade.exchange }}</div>
                    </td>
                    <td>
                        <div class="badge badge-outline">{{ trade.product }}</div>
                    </td>
                    <td>
                        <div class="trade-action {{ 'trade-action-buy' if trade.action == 'BUY' else 'trade-action-sell' }}">
                            {{ trade.action }}
                        </div>
                    </td>
                    <td class="trade-value">{{ trade.quantity }}</td>
                    <td class="trade-value">{{ trade.average_price }}</td>
                    <td class="trade-value">{{ trade.trade_value }}</td>
                    <td class="font-mono text-sm">{{ trade.orderid }}</td>
                    <td class="trade-time">{{ trade.timestamp }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Export Options -->
    <div class="flex justify-end mt-6 gap-4">
        <button class="btn btn-outline btn-sm gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Export CSV
        </button>
        <button class="btn btn-outline btn-sm gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Export PDF
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add sorting functionality to table headers
    document.querySelectorAll('th.cursor-pointer').forEach(headerCell => {
        headerCell.addEventListener('click', () => {
            const table = headerCell.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const index = Array.from(headerCell.parentElement.children).indexOf(headerCell);
            
            // Get current sort direction
            const currentDirection = headerCell.getAttribute('data-sort') || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            
            // Update sort direction
            headerCell.setAttribute('data-sort', newDirection);
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.children[index].textContent.trim();
                const bValue = b.children[index].textContent.trim();
                
                // Check if values are numbers
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Handle date sorting for timestamp column
                if (index === 8) {  // Timestamp column index
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    return newDirection === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                return newDirection === 'asc' 
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            });
            
            // Clear and repopulate tbody
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        });
    });

    // Export functionality
    document.querySelector('button:contains("Export CSV")').addEventListener('click', function() {
        // Implement CSV export
        console.log('Exporting to CSV...');
    });

    document.querySelector('button:contains("Export PDF")').addEventListener('click', function() {
        // Implement PDF export
        console.log('Exporting to PDF...');
    });
});
</script>
{% endblock %}
